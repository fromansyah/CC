<?xml version="1.0" encoding="UTF-8"?>
<configuration>  
    <system.webServer>        
        <!-- START x-xss protection -->
        <httpProtocol>
            <customHeaders>
                <add name="X-Xss-Protection" value="1; mode=block" />
                <add name="Content-Security-Policy" value="style-src 'self' 'unsafe-inline';" />
                <remove name="X-Powered-By" />
                <add name="X-Frame-Options" value="DENY" />    
                <add name="Strict-Transport-Security" value="max-age=2629800" />    
                <add name="Referrer-Policy" value="strict-origin" />    
                <add name="X-Content-Type-Options" value="nosniff" />    
                <add name="Feature-Policy" value="vibrate 'self' https://{HTTP_HOST}" />                 
            </customHeaders>
        </httpProtocol>
        <!-- END x-xss protection -->
        <rewrite>
            <rules>
                <!-- BEGIN rule TAG FOR HTTPS REDIRECT -->
                <rule name="Force HTTPS" enabled="true">
                  <match url="(.*)" ignoreCase="false" />
                  <conditions>
                    <add input="{HTTPS}" pattern="off" />
                  </conditions>
                  <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" appendQueryString="true" redirectType="Permanent" />
                  
                  <!--<match url="^(.*)$" ignoreCase="false" />
                        <conditions>
                            <add input="{REQUEST_FILENAME}" matchType="IsFile" ignoreCase="false" negate="true" />
                            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" ignoreCase="false" negate="true" />
                            <add input="{URL}" pattern="^/favicon.ico$" ignoreCase="false" negate="true" />
                        </conditions>
                  <action type="Rewrite" url="index.php/{R:1}" appendQueryString="true" redirectType="Permanent"/>-->
                </rule>
                <rule name="Rewrite to index.php">
                    <match url="index.php|robots.txt|images|test.php" />
                    <action type="None" />
                </rule>
                <rule name="Rewrite CI Index">
                    <match url=".*" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" pattern="css|js|jpg|jpeg|png|gif|ico|htm|html" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="index.php/{R:0}" />
                </rule>
                <!-- END rule TAG FOR HTTPS REDIRECT -->       
            </rules>
            <globalRules>
               <rule name="Rule 1" enabled="true" patternSyntax="Wildcard" stopProcessing="true">
                   <match url="*" />
                   <action type="Rewrite" url="http://{HTTP_HOST}/index.php/{R:0}" />
               </rule>
            </globalRules>
			<outboundRules>
                <rule name="Add Strict-Transport-Security when HTTPS" enabled="true">
                    <match serverVariable="RESPONSE_Strict_Transport_Security"
                        pattern=".*" />
                    <conditions>
                        <add input="{HTTPS}" pattern="on" ignoreCase="true" />
                    </conditions>
                    <action type="Rewrite" value="max-age=31536000" />
                </rule>
                <rule name="Add samesite attribute for csrf_cookie" enabled="true">
                   <match serverVariable="RESPONSE_Set_Cookie" pattern="csrf_cookie=(.*)" />
                   <conditions>
                        <add input="{HTTP}" pattern="on" ignoreCase="true" />
                    </conditions>
                   <action type="Rewrite" value="true" />
                </rule>
			</outboundRules>
        </rewrite>        
    </system.webServer>
</configuration>